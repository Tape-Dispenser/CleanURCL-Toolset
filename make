#!/bin/bash

# # # # # # # # # # # # # # # # # # # # #  CONFIG  # # # # # # # # # # # # # # # # # # # # #

GCCARGS="-Wall -Wextra"
GCCDEBUGARGS="-Wall -Wextra -ggdb3"

GNATARGS=""
GNATDEBUGARGS="--GCC=\"gcc -ggdb3\""

LINKARGS="-lfyaml"

BINNAME="urcltools"

SRCFOLDER="./src"
TEMPFOLDER="./temp"
BUILDFOLDER="./build"

# # # # # # # # # # # # # # # # # # # #  END CONFIG  # # # # # # # # # # # # # # # # # # # #

# iterate throught the source directory recursively, and record any found c files or ada files
scanDir() {
  local dir="${1:-$SRCFOLDER}"   
  dir=$(realpath "$dir")         
  for file in "$dir"/*; do       
    [ -e "$file" ] || continue   
    if [[ -d "$file" ]]; then
      scanDir "$file"
    elif [[ -f "$file" ]]; then
      extension="${file##*.}"
      if [[ "$extension" == "c" ]]; then
        CFILES+=("$file")
      elif [[ "$extension" == "adb" ]]; then
        ADBFILES+=("$file")
      fi
    fi
  done
}

if [ "${1}" == "debug" ]; then
  GCCARGS="${GCCDEBUGARGS}"
  GNATARGS="${GNATDEBUGARGS}"
  BUILDFOLDER="${BUILDFOLDER}/debug"
fi

# clear up temp files
rm -rf "${TEMPFOLDER}"
mkdir "${TEMPFOLDER}"

# get all source files
declare -a CFILES
declare -a ADBFILES

scanDir "${SRCFOLDER}"

echo "${CFILES[@]}"
echo "${ADBFILES[@]}"


# build c files
#gcc -ggdb3 -c main.c
for i in "${CFILES[@]}"
do
  fileName=$(basename ${i})
  fileName="${fileName%.*}"
  gcc ${GCCARGS} -c "${i}" -o "${TEMPFOLDER}/${fileName}.o"
done

# build ada files
#gnatmake --GCC="gcc -ggdb3" -c unit1.adb
adbCount=${#ADBFILES[@]}
if (( adbCount > 0 )); then
  for i in "${ADBFILES[@]}"
  do
    gnatmake ${GCCARGS} -D "${TEMPFOLDER}" -c "${i}"
  done

  # bind .ali files
  finalAli="${ADBFILES[-1]}"
  finalAli=$(basename ${finalAli})
  finalAli="${TEMPFOLDER}/${finalAli%.*}.ali"

  # get array of all .ali files
  declare -a aliFiles
  for i in "${ADBFILES[@]}"
  do
    aliFileName=$(basename ${i})
    aliFile="${TEMPFOLDER}/${aliFileName%.*}.ali"
    aliFiles[${#aliFiles[@]}]="${aliFile}"
  done

  #gnatbind -n unit1.ali unit2.ali
  adbCount=${#ADBFILES[@]}
  if (( adbCount > 0 )); then
    gnatbind -n "${aliFiles[@]}"
  fi
fi

# link into finished output

# get list of .o files generated by gcc
declare -a oFiles
for i in "${CFILES[@]}"
do
  oFileName=$(basename ${i})
  oFile="${TEMPFOLDER}/${oFileName%.*}.o"
  oFiles[${#oFiles[@]}]="${oFile}"
done

#gnatlink unit2.ali main.o -o exec_file
if (( adbCount > 0 )); then
  gnatlink "${finalAli}" "${oFiles[@]}" -o "${BUILDFOLDER}/${BINNAME}" ${LINKARGS}
  
else
  # no ada files, just compile with gcc
  gcc -o "${BUILDFOLDER}/${BINNAME}" "${oFiles[@]}" ${LINKARGS}
fi